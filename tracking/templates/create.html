{% extends 'base.html' %}
{% load static %}

{% block title %}Create Live Tracking{% endblock %}

{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="{% static 'js/create_tracking.js' %}"></script>

<h1>Create Live Tracking</h1>

<form method="post" id="tracking-form" class="fleet-edit-wrapper">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="hidden" name="tracking_data" id="tracking_data">
    <button type="submit">Create</button>
</form>

<script>
    let heading = 0;
    let headingCaptured = false;

    function requestOrientationPermission() {
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
            return DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        startOrientationListener();
                    } else {
                        console.warn('Motion sensor permission denied.');
                    }
                })
                .catch(err => console.error('Permission error:', err));
        } else {
            startOrientationListener();
            return Promise.resolve();
        }
    }

    function startOrientationListener() {
        window.addEventListener('deviceorientation', (event) => {
            if (event.alpha !== null) {
                heading = Math.round(event.alpha);
                headingCaptured = true;
                console.log('Captured heading:', heading);
            }
        });
    }

    navigator.geolocation.getCurrentPosition(async function (position) {
        const X = position.coords.latitude;
        const Y = position.coords.longitude;

        await requestOrientationPermission();

        setTimeout(() => {
            const data = {
                X: X,
                Y: Y,
                heading: headingCaptured ? heading : 0
            };

            document.getElementById('tracking_data').value = JSON.stringify(data);
        }, 3000);
    }, function (error) {
        alert("Location access is required.");
    });
</script>
{% endblock %}