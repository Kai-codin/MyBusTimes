{% extends 'base.html' %}
{% load static %}

{% block title %}{{ full_route_num }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
    html,
    body {
        height: 100%;
        overflow: hidden;
    }

    main {
        height: calc(100vh - 55px);
    }

    /* ─────────── map ─────────── */
    #map {
        position: fixed !important;
        top: 55px;
        bottom: 0;
        right: 0;
        width: 65%;
    }

    /* ─────────── stop-list panel ─────────── */
    .stop-list {
        position: fixed;
        top: 55px;
        /* under header */
        left: 0;
        bottom: 0;
        /* stretches to viewport bottom */
        width: 35%;
        background: var(--background-color);
        display: flex;
        /* column layout: scroll area + footer */
        flex-direction: column;
        z-index: 10;
    }

    /* scrolling area */
    .stop-list-content {
        flex: 1 1 auto;
        overflow-y: auto;
    }

    /* footer that never scrolls away */
    .stop-list-footer {
        flex: 0 0 auto;
        padding: 10px;
        display: flex;
        gap: .5rem;
        box-shadow: 0 -2px 4px rgb(0 0 0 / .1);
        background: var(--background-color);
    }

    th:first-child,
    td:first-child {
        text-wrap: auto;
    }

    th:last-child,
    td:last-child {
        width: 25px;
    }

    .remove-link {
        margin: 0 7.5px;
        color: rgb(196, 30, 30);
        cursor: pointer;
        width: 25px;
        position: relative;
        text-align: center;
        right: 0;
    }

    .timing-point {
        -moz-transform: rotate(-90deg);
        -webkit-transform: rotate(-90deg);
        -o-transform: rotate(-90deg);
        -ms-transform: rotate(-90deg);
        transform: rotate(-90deg);
        border: 0;
        font-weight: normal;
        text-align: center;
        padding: 5px;
        margin-top: 40px;
        display: block;
    }

    .timing-point-check-box {
    width: 0;
    text-align: center;
    }

    /* ─────────── mobile layout ─────────── */
    @media (max-width: 768px) {
        #map {
            width: 100%;
            height: 60vh;
        }

        .stop-list {
            top: 60vh;
            /* panel sits under the map */
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div id="map"></div>

<div class="stop-list">
    <!-- scrollable list -->
    <div class="stop-list-content">
        <table border="0" cellpadding="5" cellspacing="0" style="width: 100%;">
            <thead>
                <tr>
                    <th>
                        <h2>Add Stops {{ route.route_num }} {{ direction }}</h2>
                        <h3 style="margin: 0;">Stop Name</h3>
                        <button
                            onclick="location.href='{% url 'edit-stop-names-only' operator_name=operator route_id=route.id direction=direction %}'">
                            Edit Stop Names Only
                        </button>
                    </th>
                    <th class="timing-point">Timing Point</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="stopList">
                <!-- Selected stops will be added here -->
            </tbody>
        </table>
    </div>

    <!-- fixed footer with action buttons -->
    <div class="stop-list-footer">
        <button id="addCustomStop">Add Custom Stop</button>
        <button id="submitRoute">Save {{ direction }} stops</button>
    </div>
</div>

<form id="routeForm" action="" method="POST">
    {% csrf_token %}
    <input type="hidden" name="routeData" id="routeDataInput">
</form>

<p style="display: none;" id="existing-stops-data">
    {{ existing_stops|json_script:"existing-stops-data" }}
</p>

<script>
    const map = L.map('map').setView([54.238, -3.325], 6);
    L.tileLayer('{{ mapTile.tile_url }}', {
        attribution: '{{ mapTile.attribution }}',
    }).addTo(map);

    const stopList = document.getElementById('stopList');
    const selectedStops = [];
    const selectedCoords = [];
    const markersLayer = L.layerGroup().addTo(map);
    let routeLayer = null;

    // Prefill existing stops from Django context
    const existingStops = JSON.parse(document.getElementById("existing-stops-data").textContent);

    if (existingStops && Array.isArray(existingStops)) {
        existingStops.forEach(stopObj => {
            const name = stopObj.stop;
            const timing_point = stopObj.timing_point || false;
            if (!stopObj.cords || typeof stopObj.cords !== 'string' || !stopObj.cords.includes(',')) {
                console.warn(`Stop "${name}" is missing or has invalid coordinates:`, stopObj.cords);
                return; // Skip this stop
            }

            const [lat, lon] = stopObj.cords.split(',').map(Number);
            if (isNaN(lat) || isNaN(lon)) {
                console.warn(`Stop "${name}" has invalid lat/lon:`, stopObj.cords);
                return; // Skip this stop
            }

            if (!selectedStops.includes(name)) {
                selectedStops.push(name);
                selectedCoords.push({
                    lat: lat,
                    lon: lon,
                    heading: null
                });

                const tr = document.createElement('tr');
                tr.innerHTML =
                    `<td>${name}</td><td class="timing-point-check-box"><input type="checkbox" id="timing_point" ${timing_point ? 'checked' : ''}></td><td><span class="remove-link">X</span></td>`;
                const removeLink = tr.querySelector('.remove-link');

                removeLink.addEventListener('click', () => {
                    const index = selectedStops.indexOf(name);
                    if (index !== -1) {
                        selectedStops.splice(index, 1);
                        selectedCoords.splice(index, 1);
                        tr.remove();
                        updateRoute();
                    }
                });

                stopList.appendChild(tr);
            }
        });
    }

    async function fetchStops(bounds) {
        const zoom = map.getZoom();
        if (zoom < 15) {
            markersLayer.clearLayers();
            return;
        }

        const query = new URLSearchParams({
            ymax: bounds.getNorth(),
            ymin: bounds.getSouth(),
            xmax: bounds.getEast(),
            xmin: bounds.getWest()
        }).toString();

        const response = await fetch(`https://bustimes.org/stops.json?${query}`);
        const data = await response.json();

        markersLayer.clearLayers();

        for (const feature of data.features) {
            // Get lat and long from OpenStreetMap
            const [lng, lat] = feature.geometry.coordinates;
            let name = feature.properties.name || `Unnamed Stop (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
            const coords = [lat, lng];

            const marker = L.marker(coords).addTo(markersLayer);
            marker.bindPopup(name);

            if (feature.properties.bearing != null) {
                const arrowLength = 0.0003; // ~30 m
                const angleRad = feature.properties.bearing * Math.PI / 180;

                const arrowLat = lat + arrowLength * Math.cos(angleRad);
                const arrowLng = lng + arrowLength * Math.sin(angleRad);

                L.polyline(
                    [
                        [lat, lng],
                        [arrowLat, arrowLng]
                    ], {
                        color: 'red',
                        weight: 2,
                        dashArray: '4,4'
                    }
                ).addTo(markersLayer);
            }

            marker.on('click', () => {
                if (!selectedStops.includes(name)) {
                    selectedStops.push(name);
                    selectedCoords.push({
                        lat: lat,
                        lon: lng,
                        heading: feature.properties.bearing || null
                    });

                    const tr = document.createElement('tr');
                    tr.innerHTML =
                        `<td>${name}</td><td class="timing-point-check-box"><input type="checkbox" id="timing_point"></td><td><span class="remove-link">X</span></td>`;
                    const removeLink = tr.querySelector('.remove-link');

                    removeLink.addEventListener('click', () => {
                        const index = selectedStops.indexOf(name);
                        if (index !== -1) {
                            selectedStops.splice(index, 1);
                            selectedCoords.splice(index, 1);
                            tr.remove();
                            updateRoute();
                        }
                    });

                    stopList.appendChild(tr);
                    updateRoute();
                }
            });
        }
    }

    function updateRoute() {
        if (selectedCoords.length < 2) return;

        if (routeLayer) {
            map.removeLayer(routeLayer);
        }

        const latlngs = selectedCoords.map(stop => [stop.lat, stop.lon]);

        routeLayer = L.polyline(latlngs, {
            color: '#2f80ed',
            weight: 4
        }).addTo(map);
    }

    // Decode Valhalla polyline (6-digit precision)
    function decodeValhallaPolyline(encoded) {
        let index = 0,
            lat = 0,
            lng = 0,
            coordinates = [];

        while (index < encoded.length) {
            let result = 1,
                shift = 0,
                b;
            do {
                b = encoded.charCodeAt(index++) - 63 - 1;
                result += b << shift;
                shift += 5;
            } while (b >= 0x1f);
            lat += (result & 1) ? ~(result >> 1) : (result >> 1);

            result = 1;
            shift = 0;
            do {
                b = encoded.charCodeAt(index++) - 63 - 1;
                result += b << shift;
                shift += 5;
            } while (b >= 0x1f);
            lng += (result & 1) ? ~(result >> 1) : (result >> 1);

            coordinates.push([lat * 1e-6, lng * 1e-6]);
        }
        return coordinates;
    }

    fetchStops(map.getBounds());
    map.on('moveend', () => {
        fetchStops(map.getBounds());
    });

    document.getElementById('addCustomStop').addEventListener('click', () => {
        alert('Click anywhere on the map to add a custom stop.');

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const stopName = prompt('Enter stop name:');

            if (stopName) {
                const marker = L.marker([lat, lng]).addTo(markersLayer);
                marker.bindPopup(stopName).openPopup();

                selectedStops.push(stopName);
                selectedCoords.push({
                    lat: lat,
                    lon: lng,
                    heading: null
                });

                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${stopName}</td><td class="timing-point-check-box"><input type="checkbox" id="timing_point"></td><td><span class="remove-link">X</span></td>`;
                const removeLink = tr.querySelector('.remove-link');

                removeLink.addEventListener('click', () => {
                    const index = selectedStops.indexOf(stopName);
                    if (index !== -1) {
                        selectedStops.splice(index, 1);
                        selectedCoords.splice(index, 1);
                        tr.remove();
                        markersLayer.removeLayer(marker);
                        updateRoute();
                    }
                });

                stopList.appendChild(tr);
                updateRoute();
            }
            map.off('click', onMapClick);
        }
        map.on('click', onMapClick);
    });
</script>

<script>
    document.getElementById("submitRoute").addEventListener("click", () => {
        const formattedStops = [];

        // Go through each row in the stop list
        document.querySelectorAll('#stopList tr').forEach((row, index) => {
            const stopName = selectedStops[index];
            const coord = selectedCoords[index];
            const checkbox = row.querySelector('input[type="checkbox"]');
            const isTimingPoint = checkbox && checkbox.checked;

            formattedStops.push({
                stop: stopName,
                cords: `${coord.lat},${coord.lon}`,
                timing_point: isTimingPoint
            });
        });

        document.getElementById("routeDataInput").value = JSON.stringify(formattedStops);
        document.getElementById("routeForm").submit();
    });

</script>
{% endblock %}