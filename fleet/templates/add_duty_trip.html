{% extends 'mbtbase.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
  .trip-group {
    margin-top: 15px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 0.5em;
  }

  .trip-group label {
    display: block;
    margin-top: 5px;
  }

  .trip-group input {
    width: 100%;
    padding: 5px;
    box-sizing: border-box;
  }
</style>
{{ available_routes|json_script:"route-data" }}
{% endblock %}

{% block title %}Add Duty for {{ operator.operator_slug }}{% endblock %}

{% block content %}
<h2>Add Trip for Duty: {{ duty_instance.duty_name }}</h2>
<form method="post" class="fleet-edit-wrapper">
  {% csrf_token %}
  <div>
    <label for="trip_times">Trips:</label>
    <button type="button" id="add-trip">Add Trip</button>
    <div id="trips-container"></div>
  </div>

  <div style="margin-top: 30px;">
    <h3>Repeat Trips</h3>
    <label for="repeat-count">Repeat how many times:</label>
    <input type="number" id="repeat-count" min="1" value="1">

    <label for="break-minutes">Break between each trip set (in minutes):</label>
    <input type="number" id="break-minutes" min="0" value="5">

    <button type="button" id="repeat-trips" style="margin-top: 10px;">Repeat Trips</button>
  </div>

  <button type="submit" style="margin-top: 20px;">Save Trips</button>
</form>

<script>
  // Utility to add minutes to a time string "HH:MM"
  function addMinutes(time, minutesToAdd) {
    const [hours, minutes] = time.split(':').map(Number);
    const date = new Date(0, 0, 0, hours, minutes + minutesToAdd);
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }

  // Function to create a trip block (used for both adding and repeating)
  function createTripGroup(values = {}) {
    const tripGroup = document.createElement('div');
    tripGroup.classList.add('trip-group');

    function addInput(labelText, type, name, required = true, value = '') {
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.type = type;
      input.name = name;
      if (required) input.required = true;
      input.value = value || '';
      tripGroup.appendChild(label);
      tripGroup.appendChild(input);
    }

    // Route Dropdown
    const routeLabel = document.createElement('label');
    routeLabel.textContent = 'Select Route:';
    const routeSelect = document.createElement('select');
    routeSelect.name = 'route_select[]';

    const routeOptions = JSON.parse(document.getElementById('route-data').textContent);
    routeOptions.forEach(route => {
      const option = document.createElement('option');
      option.value = route.route_num;
      option.textContent = `${route.route_num} - ${route.route_inbound_destination} to ${route.route_outbound_destination}`;
      if (route.route_num === values.route_num) {
        option.selected = true;
      }
      routeSelect.appendChild(option);
    });
    tripGroup.appendChild(routeLabel);
    tripGroup.appendChild(routeSelect);

    // Route Number Field
    addInput('Route Number:', 'text', 'route_num[]', true, values.route_num);

    // Auto-fill route number when dropdown changes
    routeSelect.addEventListener('change', function () {
      tripGroup.querySelector('input[name="route_num[]"]').value = this.value;
    });

    addInput('Start Time:', 'time', 'start_time[]', true, values.start_time);
    addInput('End Time:', 'time', 'end_time[]', true, values.end_time);
    addInput('Start At:', 'text', 'start_at[]', true, values.start_at);
    addInput('End At:', 'text', 'end_at[]', true, values.end_at);

    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'Remove Trip';
    removeBtn.style.marginTop = '10px';
    removeBtn.addEventListener('click', () => {
      tripGroup.remove();
    });
    tripGroup.appendChild(removeBtn);

    return tripGroup;
  }

  // Add Trip button
  document.getElementById('add-trip').addEventListener('click', function (e) {
    e.preventDefault();
    const container = document.getElementById('trips-container');
    container.appendChild(createTripGroup());
  });

  // Repeat Trips button
  document.getElementById('repeat-trips').addEventListener('click', function () {
    const repeatCount = parseInt(document.getElementById('repeat-count').value);
    const breakMinutes = parseInt(document.getElementById('break-minutes').value);
    const container = document.getElementById('trips-container');
    const originalTrips = Array.from(container.querySelectorAll('.trip-group'));

    if (originalTrips.length === 0 || repeatCount <= 0) return;

    // Clone original data first
    const tripsToRepeat = originalTrips.map(group => {
      return {
        route_num: group.querySelector('input[name="route_num[]"]').value,
        start_time: group.querySelector('input[name="start_time[]"]').value,
        end_time: group.querySelector('input[name="end_time[]"]').value,
        start_at: group.querySelector('input[name="start_at[]"]').value,
        end_at: group.querySelector('input[name="end_at[]"]').value,
      };
    });

    // Clear the container
    container.innerHTML = '';

    let latestEndTime = null;

    for (let i = 0; i < repeatCount; i++) {
      tripsToRepeat.forEach(values => {
        const trip = { ...values };

        if (latestEndTime) {
          trip.start_time = addMinutes(latestEndTime, breakMinutes);
          const duration = (
            new Date(`1970-01-01T${values.end_time}`) -
            new Date(`1970-01-01T${values.start_time}`)
          ) / 60000;
          trip.end_time = addMinutes(trip.start_time, duration);
        }

        latestEndTime = trip.end_time;
        container.appendChild(createTripGroup(trip));
      });
    }
  });
</script>
{% endblock %}