{% extends 'base.html' %}
{% load static %}
{% load url_filters %}

{% block title %}{{ route.route_num }} Route Map{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
  html,
  body,
  main {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #map {
    position: fixed !important;
    top: 55px;
    bottom: 0;
    width: 100%;
    left: 0;
  }

  #directionToggle {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 1000;
    background: var(--brand-color);
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<button id="directionToggle">Show Outbound</button>
<div id="map"></div>

<script>
  const routeId = {{ route.id }};
  const operatorName = "{{ operator.operator_name }}";

  let currentDirection = "inbound"; // default view

  const map = L.map('map').setView([54.238, -3.325], 6);

  L.tileLayer('{{ mapTile.tile_url }}', {
    attribution: '{{ mapTile.attribution }}',
  }).addTo(map);

  let markersLayer = L.layerGroup().addTo(map);
  let routeLayer = null;

  async function loadRoute(direction) {
    // Clear previous layers
    markersLayer.clearLayers();
    if (routeLayer) {
      map.removeLayer(routeLayer);
      routeLayer = null;
    }

    // Fetch stops
    const stopsResponse = await fetch(`/api/routes/${routeId}/stops/?direction=${direction}`);
    if (!stopsResponse.ok) {
      alert("Failed to load route stops");
      return;
    }
    const stops = await stopsResponse.json();

    const latlngs = stops.map(stop => stop.cords.split(',').map(Number));

    // Add route polyline FIRST so it appears below the stop icons
    if (latlngs.length >= 2) {
      routeLayer = L.polyline(latlngs, {
        color: '#2f80ed',
        weight: 4,
        zIndex: 1
      }).addTo(map);
    }

    // THEN add stop markers so they appear on top
    stops.forEach(stop => {
      const [lat, lon] = stop.cords.split(',').map(Number);
      const marker = L.circleMarker([lat, lon], {
        radius: 6,
        color: '#2f80ed',
        fillColor: '#ffffff',
        fillOpacity: 1,
        weight: 4
      }).addTo(markersLayer);
      marker.bindPopup(`<a href="/stop/?name=${stop.stop|urlquote}">${stop.stop}</a>`);
    });

    // Adjust view
    if (routeLayer) {
      map.fitBounds(routeLayer.getBounds());
    } else {
      map.fitBounds(markersLayer.getBounds());
    }
  }

  // Toggle button logic
  const toggleBtn = document.getElementById('directionToggle');
  toggleBtn.addEventListener('click', () => {
    if (currentDirection === 'inbound') {
      currentDirection = 'outbound';
      toggleBtn.textContent = 'Show Inbound';
    } else {
      currentDirection = 'inbound';
      toggleBtn.textContent = 'Show Outbound';
    }
    loadRoute(currentDirection);
  });

  // Initial load
  loadRoute(currentDirection);
</script>
{% endblock %}