{% extends 'base.html' %}
{% load static %}

{% block title %}Vehicles - {{ operator.operator_name }}{% endblock %}

{% block extra_css %}

<style>
    @media print {

        /* Hide anything you donâ€™t want to print */
        .no-print,
        td:nth-child(13),
        /* Adjust this to target the Flickr column */
        th:nth-child(13),
        a[href*="flickr.com"] {
            display: none !important;
        }

        /* Optional: make the table fill the page */
        .table-wrapper {
            margin: 0;
            padding: 0;
        }

        /* Optional: better layout for printing */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        .livery-cell {
            width: 2.25em;
            height: 1.5em;
            display: inline-block;
            vertical-align: text-top;
            text-align: center;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px;
        }

        .flickr-link, .edit-link {
            display: none !important;
        }
    }
</style>
{% endblock %}


{% block content %}

<h1>
    {{ operator.operator_name }}
</h1>
{% if depot %}
<p style="margin-top: -1.5em;margin-bottom: 0em;">Depot: {{ depot }}</p>
<a href="/operator/{{ operator.operator_name }}/vehicles">View Full Fleet</a>
{% endif %}

{% if operator.group %}
<p style="margin-top: -1em;margin-bottom: 2em;">Part of <a href="/group/{{ operator.group.group_name }}">{{ operator.group.group_name }}</a></p>
{% endif %}

{% include "partials/tabs.html" with tabs=tabs %}

<ul class="horizontal">
    <li><a href="/operator/history?operator={{ operator.id }}&approved=true">Recent Edits</a></li>
    <!--<li><a href="/history?operator={{ operator.id }}&pending=true">Pending Edits</a></li>-->
    {% if request.GET.withdrawn == "true" %}
    <li><a href="/operator/{{ operator.operator_name }}/vehicles">Hide Withdrawn</a></li>
    {% else %}
    <li><a href="/operator/{{ operator.operator_name }}/vehicles?withdrawn=true">Show Withdrawn</a></li>
    {% endif %}
</ul>

<button onclick="printTable()" class="no-print">Print</button>
<br>

<div id="printable-area"  class="table-wrapper">
    {% if vehicles %}
    <table class="fleet" border="0" cellpadding="10" cellspacing="0">
        <thead>
            <tr>
                <th colspan="2"></th>
                <th colspan="2">Last Tracked</th>

                <th>Type</th>
                {% if show_livery %}
                <th>Livery</th>
                {% endif %}
                {% if show_branding %}
                <th>Branding</th>
                {% endif %}
                {% if show_prev_reg %}
                <th>Prev Reg</th>
                {% endif %}
                {% if show_name %}
                <th>Name</th>
                {% endif %}
                {% if show_depot %}
                <th>Depot</th>
                {% endif %}
                {% if show_features %}
                <th>Features</th>
                {% endif %}

                {% if 'owner' in helper_permissions or 'Edit Buses' in helper_permissions %}
                <th colspan="2"></th>
                {% else %}
                <th></th>
                {% endif %}
            </tr>
        </thead>

        <tbody>
            {% for item in vehicles %}
            <tr id="{{ item.fleet_number }}-{{ item.operator.operator_code }}"
                class="{% if not item.in_service %}withdrawn{% endif %}">

                {% if item.fleet_number %}
                <td  {% if not item.reg %}colspan="2"{% endif %}><a href="{% url 'vehicle_detail' operator_name=item.operator.operator_name vehicle_id=item.id %}">
                        {{ item.fleet_number }}{% if item.for_sale %}*{% endif %}</a></td>
                {% endif %}
                
                {% if item.reg %}
                <td class="reg" {% if not item.fleet_number %}colspan="2"{% endif %}><a
                        href="{% url 'vehicle_detail' operator_name=item.operator.operator_name vehicle_id=item.id %}">
                        {{ item.reg|upper }}</a></td>
                {% endif %}

                {% if not item.reg and not item.fleet_number %}
                <td colspan="2" class="no-reg"></td>
                {% endif %}

                <td>
                    {% if item.last_trip_route %}
                    {{ item.last_trip_route }}
                    {% endif %}
                </td>

                <td>
                    {{ item.last_trip_display }}
                </td>

                <td>
                    {% if item.vehicle_type_data %}
                    {{ item.vehicle_type_data.type_name }}
                    {% endif %}
                    {% if item.type_details != 'NULL' %}
                    {{ item.type_details }}
                    {% endif %}
                    {% if item.open_top %} | Open Top{% endif %}
                </td>

                {% if show_livery %}
                <td>
                    {% if item.colour and item.colour != 'NULL' %}
                        <div class="livery-cell" style="background: {{ item.colour }};" title="{{ item.branding }}"></div>
                        {{ item.branding }}
                    {% else %}
                    <div class="livery-cell" style="background: {{ item.livery.left_css }};"
                        title="{{ item.livery.name }}"></div>
                    {{ item.livery.name }}
                    {% endif %}
                </td>
                {% endif %}

                {% if show_branding %}
                <td>
                    {% if item.livery %}
                    {{ item.branding }}
                    {% endif %}
                </td>
                {% endif %}

                {% if show_prev_reg %}
                <td>
                    {{ item.prev_reg }}
                </td>
                {% endif %}

                {% if show_name %}
                <td>
                    {{ item.name }}
                </td>
                {% endif %}

                {% if show_features %}
                <td>
                    {% if item.features %}
                    {% with features=item.features|default:"[]" %}
                    {% if features|length > 0 %}
                    {{ features|join:", " }}
                    {% endif %}
                    {% endwith %}
                    {% endif %}
                </td>
                {% endif %}

                {% if show_depot %}
                <td>
                    <a href="?depot={{ item.depot|urlencode }}">{{ item.depot }}</a>
                </td>
                {% endif %}

                <td class="flickr-link">
                    <a target="_blank"
                        href="https://www.flickr.com/search/?text={{ item.reg }}%20or%20{{ item.reg|cut:' ' }}{% if item.prev_reg %}%20or%20{{ item.prev_reg }}%20or%20{{ item.prev_reg|cut:' ' }}{% endif %}&sort=date-taken-desc">Flickr</a>
                </td>

                {% if 'owner' in helper_permissions or 'Edit Buses' in helper_permissions %}
                <td class="edit-link"><a 
                        href="{% url 'vehicle_edit' operator_name=item.operator.operator_name vehicle_id=item.id %}">Edit</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>

    </table>
    {% else %}
    {% endif %}
</div>
<script>
function printTable() {
    const printable = document.getElementById('printable-area').innerHTML;
    const original = document.body.innerHTML;

    document.body.innerHTML = `
      <html>
      <head>
        <title>Print Fleet Table</title>
        <style>
          body {
            font-family: Arial, sans-serif;
          }
          table {
            border-collapse: collapse;
            width: 100%;
          }
          th, td {
            border: 1px solid #ccc;
            padding: 6px;
          }
          .livery-cell {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
          }
        </style>
      </head>
      <body>
        ${printable}
      </body>
      </html>
    `;

    window.print();
    document.body.innerHTML = original;
    location.reload(); // Reload to restore JS, event listeners etc.
}
</script>


{% endblock %}