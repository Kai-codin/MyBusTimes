{% extends 'base.html' %}
{% load static %}

{% block title %}Vehicles - {{ operator.operator_name }}{% endblock %}

{% block extra_css %}

<style>
    .on_loan {
            opacity: 0.5;
        }
    @media print {

        /* Hide anything you donâ€™t want to print */
        .no-print,
        td:nth-child(13),
        /* Adjust this to target the Flickr column */
        th:nth-child(13),
        a[href*="flickr.com"] {
            display: none !important;
        }

        /* Optional: make the table fill the page */
        .table-wrapper {
            margin: 0;
            padding: 0;
        }

        /* Optional: better layout for printing */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        .livery-cell {
            width: 2.25em;
            height: 1.5em;
            display: inline-block;
            vertical-align: text-top;
            text-align: center;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px;
        }

        .flickr-link, .edit-link {
            display: none !important;
        }
    }
</style>
{% endblock %}


{% block content %}

<h1 style="margin-bottom: -.5em;">
    {{ operator.operator_name }}
</h1>
{% if depot %}
<p style="margin-bottom: 0em;">Depot: {{ depot }}</p>
<a href="/operator/{{ operator.operator_slug }}/vehicles">View Full Fleet</a>
{% endif %}

{% if operator.group %}
<p>Part of <a href="/group/{{ operator.group.group_name }}">{{ operator.group.group_name }}</a></p>
{% endif %}
{% if operator.organisation %}
<p>Part of <a href="/organisation/{{ operator.organisation.organisation_name }}">{{ operator.organisation.organisation_name }}</a></p>
{% endif %}
<br>
<div class="ad-box" id="body-ad-1"></div>

{% include "partials/tabs.html" with tabs=tabs %}

<ul class="horizontal">
    <li><a href="/operator/history?operator={{ operator.id }}&approved=true">Recent Edits</a></li>
    <!--<li><a href="/history?operator={{ operator.id }}&pending=true">Pending Edits</a></li>-->
    {% if request.GET.withdrawn == "true" %}
    <li><a href="/operator/{{ operator.operator_slug }}/vehicles">Hide Withdrawn</a></li>
    {% else %}
    <li><a href="/operator/{{ operator.operator_slug }}/vehicles?withdrawn=true">Show Withdrawn</a></li>
    {% endif %}
</ul>

<button onclick="printTable()" class="no-print">Print</button>
<br>

<div id="printable-area"  class="table-wrapper">
    {% if vehicles %}
    <table class="fleet" border="0" cellpadding="10" cellspacing="0">
        <thead>
            <tr>
                <th colspan="2"></th>
                <th colspan="2">Last Tracked</th>

                <th>Type</th>
                {% if show_livery %}
                <th>Livery</th>
                {% endif %}
                {% if show_branding %}
                <th>Branding</th>
                {% endif %}
                {% if show_prev_reg %}
                <th>Prev Reg</th>
                {% endif %}
                {% if show_name %}
                <th>Name</th>
                {% endif %}
                {% if show_features %}
                <th>Features</th>
                {% endif %}
                {% if show_depot %}
                <th>Depot</th>
                {% endif %}

                {% if 'owner' in helper_permissions or 'Edit Buses' in helper_permissions %}
                <th colspan="2"></th>
                {% else %}
                <th></th>
                {% endif %}
            </tr>
        </thead>

        <tbody>
            {% for item in vehicles %}
            <tr id="{{ item.fleet_number }}-{{ item.operator__operator_code }}"
                class="{% if not item.in_service %}withdrawn {% endif %}{% if item.onloan %}on_loan {% endif %}">

                {% if item.fleet_number %}
                <td  {% if not item.reg %}colspan="2"{% endif %}><a href="{% url 'vehicle_detail' operator_slug=item.operator__operator_slug vehicle_id=item.id %}">
                        {{ item.fleet_number }}{% if item.for_sale %}*{% endif %}</a></td>
                {% endif %}
                
                {% if item.reg %}
                <td class="reg" {% if not item.fleet_number %}colspan="2"{% endif %}><a
                        href="{% url 'vehicle_detail' operator_slug=item.operator__operator_slug vehicle_id=item.id %}">
                        {{ item.reg|upper }}</a></td>
                {% endif %}

                {% if not item.reg and not item.fleet_number %}
                <td colspan="2" class="no-reg"></td>
                {% endif %}

                <td>
                    {% if item.last_trip_route %}
                    {{ item.last_trip_route }}
                    {% endif %}
                </td>

                <td>
                    {% if item.last_trip_display %}
                    {{ item.last_trip_display|default:"" }}
                    {% endif %}
                </td>

                <td>
                    {% if item.vehicleType__type_name %}
                    {{ item.vehicleType__type_name }}
                    {% endif %}
                    {% if item.type_details != 'NULL' %}
                    {{ item.type_details }}
                    {% endif %}
                    {% if item.open_top %} | Open Top{% endif %}
                </td>

                {% if show_livery %}
                <td>
                    {% if item.colour and item.colour != 'NULL' %}
                        <div class="livery-cell" style="background: {{ item.colour }};" title="{{ item.branding }}"></div>
                        {{ item.branding }}
                    {% else %}
                    <div class="livery-cell" style="background: {{ item.livery__left_css }};"
                        title="{{ item.livery__name|default:"" }}"></div>
                    {{ item.livery__name|default:"" }}
                    {% endif %}
                </td>
                {% endif %}

                {% if show_branding %}
                <td>
                    {% if item.livery__name %}
                    {{ item.branding }}
                    {% endif %}
                </td>
                {% endif %}

                {% if show_prev_reg %}
                <td>
                    {{ item.prev_reg }}
                </td>
                {% endif %}

                {% if show_name %}
                <td>
                    {{ item.name }}
                </td>
                {% endif %}

                {% if show_features %}
                <td>
                    {% if item.features %}
                    {% with features=item.features|default:"[]" %}
                    {% if features|length > 0 %}
                    {{ features|join:", " }}
                    {% endif %}
                    {% endwith %}
                    {% endif %}
                </td>
                {% endif %}

                {% if show_depot %}
                <td>
                    <a href="?depot={{ item.depot|urlencode }}">{{ item.depot }}</a>
                </td>
                {% endif %}

                <td class="flickr-link">
                    <a target="_blank"
                        href="https://www.flickr.com/search/?text={{ item.reg }}%20or%20{{ item.reg|cut:' ' }}{% if item.prev_reg %}%20or%20{{ item.prev_reg }}%20or%20{{ item.prev_reg|cut:' ' }}{% endif %}&sort=date-taken-desc">Flickr</a>
                </td>

                {% if 'owner' in helper_permissions or 'Edit Buses' in helper_permissions %}
                <td class="edit-link"><a 
                        href="{% url 'vehicle_edit' operator_slug=item.operator__operator_slug vehicle_id=item.id %}">Edit</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>

    </table>

    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page=1{% if request.GET.withdrawn %}&withdrawn={{ request.GET.withdrawn }}{% endif %}">&laquo; First</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.withdrawn %}&withdrawn={{ request.GET.withdrawn }}{% endif %}">Previous</a>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.withdrawn %}&withdrawn={{ request.GET.withdrawn }}{% endif %}">Next</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.withdrawn %}&withdrawn={{ request.GET.withdrawn }}{% endif %}">Last &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    {% endif %}
</div>
<script>
function printTable() {
    const printable = document.getElementById('printable-area').innerHTML;
    const original = document.body.innerHTML;

    document.body.innerHTML = `
      <html>
      <head>
        <title>Print Fleet Table</title>
        <style>
          body {
            font-family: Arial, sans-serif;
          }
          table {
            border-collapse: collapse;
            width: 100%;
          }
          th, td {
            border: 1px solid #ccc;
            padding: 6px;
          }
          .livery-cell {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
          }
        </style>
      </head>
      <body>
        ${printable}
      </body>
      </html>
    `;

    window.print();
    document.body.innerHTML = original;
    location.reload(); // Reload to restore JS, event listeners etc.
}
</script>


{% endblock %}