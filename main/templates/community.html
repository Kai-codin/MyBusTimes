{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">

<style>
    .half {
        max-height: 300px;
        overflow: scroll;
    }

    @media (min-width: 48em) {
        .full-sub {
            justify-content: space-between;
            margin: -1em 0;
            display: flex;
        }

        .full {
            width: 100%;
        }

        .half {
            width: calc(50% - 10px);
        }
    }

    p {
        margin-top: 0;
    }

    h4 {
        margin-bottom: 0;
    }

    #uploaded-image {
        max-height: 300px;
        width: auto;
        max-width: 100%;
        margin: 0 auto;
        display: block;
    }

    .img-container p {
        text-align: center;
    }

    .pfp-img {
        height: 40px;
        width: 40px;
        object-fit: cover;
        border-radius: 50%;
    }

    .user-info-post {
        display: flex;
        /* horizontal layout */
        align-items: center;
        /* vertically center items */
        gap: 10px;
        /* space between pfp and text */
    }

    .user-text {
        display: flex;
        flex-direction: column;
        /* stack username and date vertically */
        justify-content: center;
        margin-left: -5px;
    }

    .user-text a,
    .user-text p {
        margin: 0;
        font-weight: 700;
        color: var(--text-color);
        /* remove default margins */
    }

    .user-text small {
        margin: 0;
        opacity: 0.6;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block title %}Community{% endblock %}

{% block extra_js %}
<script>
    function fetchRandomCommunityImage() {
        fetch("{% url 'get_random_community_image' %}")
            .then(response => response.json())
            .then(data => {
                if (data.image_url) {
                    document.getElementById("uploaded-image").src = data.image_url;
                    document.getElementById("username").innerText = data.uploaded_by;
                } else {
                    console.error("Error fetching image:", data.error);
                }
            })
            .catch(error => console.error("Error:", error));
    }

    function updateChat() {
        fetch("https://www.mybustimes.cc/api/thread/5/")
            .then(response => response.json())
            .then(data => {
                const chatContainer = document.querySelector(".chat-container");
                chatContainer.innerHTML = ""; // Clear old messages

                data.posts.forEach(postData => {
                    const messageDiv = document.createElement("div");
                    messageDiv.classList.add("message");

                    // Optional profile picture
                    let pfpHtml = "";
                    if (postData.pfp) {
                        pfpHtml =
                            `<img src="${postData.pfp}" onerror="this.src='/media/images/default_profile_pic.png'" alt="pfp" class="pfp-img"> `;
                    } else {
                        pfpHtml =
                            `<img src="/media/images/default_profile_pic.png" alt="pfp" class="pfp-img"> `;
                    }

                    // Format time (simple: cut to hours/mins)
                    const createdAt = new Date(postData.post.created_at);
                    const timeString = createdAt.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    messageDiv.innerHTML = `
                        <div class="user-info-post">
                            <a href="/u/${postData.author}">
                            ${pfpHtml}
                            </a>
                            <a href="/u/${postData.author}">
                            <div class="user-text">
                                <p class="username">${postData.author}</p>
                                <small class="time">${timeString}</small><br />
                            </div>
                            </a>
                        </div>
                        <span class="text">${postData.post.content}</span><br /><br />
                    `;

                    chatContainer.appendChild(messageDiv);
                });
            })
            .catch(error => console.error("Error fetching chat messages:", error));
    }


    setInterval(fetchRandomCommunityImage, 10000);
    setInterval(updateChat, 5000);
    // Fetch a random community image on page load
    document.addEventListener("DOMContentLoaded", fetchRandomCommunityImage);
    document.addEventListener("DOMContentLoaded", updateChat);
</script>
{% endblock %}

{% block content %}

<h1>Community Hub</h1>

<div class="full-sub">
    <div class="half">
        <div class="img-container">
            <img src="" alt="Uploaded By" id="uploaded-image" />
            <p>Uploaded By: <span id="username">Username</span></p>
        </div>
    </div>
    <div class="half">
        <h3 style="position: sticky;top: 0;background: var(--background-color);padding: 0.25em 0;">Recent Updates</h3>
        <ul>
            {% for update in recent_updates %}
            <li>
                <h4>{{ update.title }} - {{ update.updated_at|date:"d/m/y" }}</h4>
                <p>
                    {{ update.description|linebreaksbr }}
                </p>
            </li>
            {% empty %}
            <li>No recent updates available.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="full-sub">
    <div class="half">
        <h3>Fun Stuff</h3>
        <ul>
            <li>Bus Displays</li>
            <li>Forums</li>
            <li>Messages</li>
        </ul>
    </div>
</div>

<div class="full">
    <h3>General Chat</h3>
    <div class="chat-container">
        <div class="message">
            <span class="username">User1:</span>
            <span class="text">Hello everyone!</span>
        </div>
        <div class="message">
            <span class="username">User2:</span>
            <span class="text">Hi User1!</span>
        </div>
    </div>
</div>

{% endblock %}