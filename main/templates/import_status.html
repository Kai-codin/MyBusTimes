{% extends "base.html" %}
{% block title %}Import Status{% endblock %}
{% load static %}
{% block extra_css %}
<style>
    #progress-container {
        width: 100%;
        background-color: #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }
    #progress-bar {
        height: 25px;
        width: 0%;
        background-color: var(--brand-color);
        text-align: center;
        line-height: 25px;
        color: var(--text-color);
        transition: width 0.5s;
    }
</style>
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
{% endblock %}

{% block content %}
    <h1>Import Status</h1>
    
    <div id="progress-container">
        <div id="progress-bar">0%</div>
    </div>

    <p><strong>Status:</strong> <span id="status">{{ status }}</span></p>
    <p><strong>Progress:</strong> <span id="progress">{{ progress }}</span>%</p>
    <p><strong>Message:</strong> <span id="message">{{ message }}</span></p>

    {% if username_message %}
    <h2>
        Due to your username having an invalid format, it has been sanitized.
        {% if username_message %}
            <span style="color: red;">{{ username_message }}</span>
        {% else %}
            <span style="color: green;">Your username is now valid.</span>
        {% endif %}
    </h2>
    {% endif %}
    <button onclick='window.location.href="/account/login/"' id="loginButton" style="display: none;">Go To Login</button>

    <button onclick='window.location.href="https://v1.mybustimes.cc/BusTimes/migrate"' id="restartButton">Restart Migration</button>

    <script>
        const jobId = "{{ job_id }}";

        function fetchStatus() {
            fetch(`/import-status/data/${jobId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('status').textContent = data.status;
                    document.getElementById('progress').textContent = data.progress;
                    document.getElementById('message').textContent = data.message;

                    const progressBar = document.getElementById('progress-bar');
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress + '%';

                    if (progressBar.style.width === '100%') {
                        progressBar.style.backgroundColor = '#4caf50'; // Green when complete
                        document.getElementById('loginButton').style.display = 'block';
                        document.getElementById('restartButton').style.display = 'none';
                    } else if (data.status === 'error') {
                        progressBar.style.backgroundColor = '#f44336'; // Red on error
                    } else {
                        progressBar.style.backgroundColor = '#8cb9d5'; // Blue for in-progress
                    }

                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(refreshInterval);
                    }
                });
        }

        const refreshInterval = setInterval(fetchStatus, 1000);
    </script>
{% endblock %}