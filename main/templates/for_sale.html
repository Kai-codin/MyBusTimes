{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wide.css' %}">
<style>
    .popup {
        z-index: 1000;
    }
    .filters {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    .filters select, .filters input {
        padding: 5px;
        border-radius: 0.5em;
        border: 1px solid var(--border-color);
    }
</style>
{% endblock %}

{% block title %}For Sale Vehicles{% endblock %}

{% block content %}

<h2>For Sale Vehicles</h2>

<!-- Filters -->
<div class="filters">
    <input type="text" id="searchInput" placeholder="Search...">

    <!-- Vehicle Types -->
    <select id="filterType">
        <option value="">All Types</option>
        {% for t in vehicle_types %}
            <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
    </select>

    <!-- Operators -->
    <select id="filterOperator">
        <option value="">All Operators</option>
        {% for o in operators %}
            <option value="{{ o }}">{{ o }}</option>
        {% endfor %}
    </select>

    <!-- Liveries -->
    <select id="filterLivery">
        <option value="">All Liveries</option>
        {% for l in liveries %}
            <option value="{{ l }}">{{ l }}</option>
        {% endfor %}
    </select>

</div>

{% if operators_with_vehicles %}
    {% for operator, vehicles in operators_with_vehicles.items %}
    <div id="operator_{{ operator.id }}">
        <h3>{{ operator }} - {{ vehicles|length }} Vehicles</h3>
        <hr style="margin-bottom: 0;"><br>
        <div class="vehicle-grid">
            {% for vehicle in vehicles %}
            <ul class="vehicle" id="vehicle_{{ vehicle.id }}"
                data-type="{{ vehicle.vehicleType|escapejs }}"
                data-operator="{{ operator|escapejs }}"
                data-livery="{{ vehicle.livery.name|escapejs }}"
                data-search="{{ vehicle.fleet_number }} {{ vehicle.reg }} {{ vehicle.vehicleType }} {{ vehicle.livery.name }} {{ operator }}">
                <li style="margin-bottom: 10px;">
                    <div class="livery-cell" style="background: {{ vehicle.livery.left_css }};"></div>
                    {{ vehicle.livery.name }}
                </li>
                <li>{{ vehicle.fleet_number }} - {{ vehicle.reg }}</li>
                <hr>
                <li>{{ vehicle.vehicleType }}</li>
                <li><button onclick="openBuyPopup('{{ vehicle.id }}')">Buy</button></li>
            </ul>
            {% if forloop.counter|divisibleby:12 %}
        </div>
        <div class="ad-box ad-box-narrow" id="body-ad-1"></div>
        <div class="vehicle-grid">
            {% endif %}
            {% endfor %}
        </div>
        <div class="ad-box ad-box-narrow" id="body-ad-2"></div>
    </div>
    {% endfor %}
{% else %}
    <p>No vehicles for sale.</p>
{% endif %}

<!-- Buy Vehicle Popup -->
<div class="popup" id="buyPopup">
    <div class="popup-content">
        <h3 style="margin-top: 0;">Buy Vehicle</h3>
        <form method="POST" action="">
            {% csrf_token %}
            <input type="hidden" name="vehicle_id" id="vehicle_id_input">
            <label for="operator_select">Select Operator:</label>
            <select name="operator_id" id="operator_select" required>
                {% for op in allowed_operators %}
                    <option value="{{ op.id }}">{{ op.operator_name }}</option>
                {% endfor %}
            </select>
            <br><br>
            <button type="submit" class="confirm">Confirm</button>
        </form>
    </div>
</div>

<script>
    function filterVehicles() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const type = document.getElementById('filterType').value;
        const operator = document.getElementById('filterOperator').value;
        const livery = document.getElementById('filterLivery').value;

        // Loop over each operator block
        document.querySelectorAll('[id^="operator_"]').forEach(opDiv => {
            let hasVisible = false;
            const operatorName = opDiv.querySelector('h3').textContent.toLowerCase();

            // If filtering by operator, check block first
            if (operator && !operatorName.includes(operator.toLowerCase())) {
                opDiv.style.display = 'none';
                return; // skip vehicles inside
            }

            // Loop vehicles inside this operator block
            opDiv.querySelectorAll('.vehicle').forEach(vehicle => {
                const matchesSearch = vehicle.dataset.search.toLowerCase().includes(search);
                const matchesType = !type || vehicle.dataset.type === type;
                const matchesLivery = !livery || vehicle.dataset.livery === livery;

                if (matchesSearch && matchesType && matchesLivery) {
                    vehicle.style.display = '';
                    hasVisible = true;
                } else {
                    vehicle.style.display = 'none';
                }
            });

            // Hide operator block if no vehicles are visible
            opDiv.style.display = hasVisible ? '' : 'none';
        });
    }

    document.getElementById('searchInput').addEventListener('input', filterVehicles);
    document.getElementById('filterType').addEventListener('change', filterVehicles);
    document.getElementById('filterOperator').addEventListener('change', filterVehicles);
    document.getElementById('filterLivery').addEventListener('change', filterVehicles);
</script>

{% endblock %}
