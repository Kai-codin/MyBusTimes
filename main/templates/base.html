{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <!-- <% var useFont = typeof useFont !== 'undefined' ? useFont : false; %>
    <% var style = typeof useFont !== 'undefined' ? style : narrow; %>
    <% var noAds = typeof useFont !== 'undefined' ? noAds : false; %> -->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  {% if google_ads_enabled %}
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8764676296426896"
    crossorigin="anonymous"></script>
  {% endif %}

  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//analytics.mybustimes.cc/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->

  <link rel="icon" type="image/png"
    href="https://github.com/Kai-codin/MBT-Media-Kit/blob/main/MBT%20Logos/favicon/favicon-96x96.png?raw=true"
    sizes="96x96" />
  <link rel="icon" type="image/svg+xml"
    href="https://github.com/Kai-codin/MBT-Media-Kit/blob/main/MBT%20Logos/favicon/favicon.svg?raw=true" />
  <link rel="shortcut icon"
    href="https://github.com/Kai-codin/MBT-Media-Kit/blob/main/MBT%20Logos/favicon/favicon.ico?raw=true" />
  <link rel="apple-touch-icon" sizes="180x180"
    href="https://github.com/Kai-codin/MBT-Media-Kit/blob/main/MBT%20Logos/favicon/apple-touch-icon.png?raw=true" />
  <meta name="apple-mobile-web-app-title" content="MyBusTimes" />
  <link rel="manifest"
    href="https://github.com/Kai-codin/MBT-Media-Kit/blob/main/MBT%20Logos/favicon/site.webmanifest?raw=true" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" id="theme-stylesheet" href="{% static 'themes/' %}{{ theme }}">
  {% block extra_css %}{% endblock %}

  {% block extra_js %}{% endblock %}

  <meta name="theme-color" content="#<%= brandColor %>">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {% block extra_meta %}{% endblock %}

  <title>
    {% block title %}{% endblock %} - MyBusTimes
  </title>
  <style>
    .messages {
      display: flex;
      justify-content: center;
    }

    .alert {
      padding: 10px;
      margin: 10px;
      border-radius: 4px;
      font-weight: bold;
      position: fixed;
      z-index: 1000;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
    }

    .alert-error,
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
    }

    .alert-info {
      background: #cce5ff;
      color: #004085;
    }
  </style>

</head>

<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PN8ZVKWT" height="0" width="0"
      style="display:none;visibility:hidden"></iframe></noscript>
  <!-- Matomo Image Tracker-->
  <img referrerpolicy="no-referrer-when-downgrade" src="https://analytics.mybustimes.cc/matomo.php?idsite=1&amp;rec=1" style="border:0" alt="" />
  <!-- End Matomo -->
  <header>
    <div class="site-header">
      <a href="/"><img id="logo" src="{{ menuLogo }}" height="55px" alt="My Bus Times Logo"></a>
      <button id="menu-toggle"><img id="menu" src="{{ burgerMenuLogo }}" height="35px" alt="Burger Menu Icon"></button>
      <form action="/search">
        <input type="search" name="q" id="q" placeholder="Search" style="text-wrap: nowrap;">
        <input type="submit" value="Search">
      </form>
      <div>
        <nav id="nav-menu">
          <ul>
            {% if ads_enabled == True %}
            <li><a href="/account/subscribe">Go Ads Free</a></li>
            {% endif %}
            <li>
              {% if request.user.is_authenticated %}
              <a id="profile" href="/u/{{ request.user.username }}/">My Profile</a>
              {% else %}
              <a id="profile" href="/account/login/">Login</a>
              {% endif %}
            </li>
            {% if admin %}
              <li><a href="/admin/">Admin Portal</a></li>
            {% endif %}
            <li><a id="tracking-profile" href="/map/">Map</a></li>
            <li>
              {% if request.user.is_authenticated %}
              <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
                {% csrf_token %}
              </form>
              <a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">Logout</a>
              {% endif %}
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>
  <div id="service-updates-banner">
    <span id="banner-text"></span>
  </div>
  <button id="dismiss-btn" style="float: right;">X</button>
  <main>
    <div class="breadcrumb">
      <ol>
        {% for item in breadcrumbs %}
        <li class="{{ item.className|default:'default' }}">
          {% if forloop.last %}
          <a href="{{ item.url }}">
            <span>
              {{ item.name }}</span>
          </a>
          {% else %}
          <a href="{{ item.url }}">
            <span>
              {{ item.name }}</span>
          </a>
          {% endif %}
        </li>
        {% endfor %}
      </ol>
    </div>
    <div class="content">
      {% if messages %}
      <div class="messages">
        {% for message in messages %}
        <div class="alert 
                      {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      {% if banned == False  %}
      {% block content %}

      {% endblock content %}
      {% else %}
      <div class="alert alert-danger">
        {% if user_banned == True %}
        <h2>Account Banned</h2>
        <p>Your account has been banned. If you believe this is a mistake, please contact support.</p>
        {% elif ip_banned == True %}
        <h2>IP Banned</h2>
        <p>Your IP address has been banned. If you believe this is a mistake, please contact support.</p>
        {% else %}
        <h2>Banned</h2>
        <p>You have been banned. If you believe this is a mistake, please contact support.</p>
        {% endif %}
        <p><a href="mailto:support@mybustimes.cc"
            style="text-align: center;color: #f8d7da;background: #721c24;padding: .5em .5em;border-radius: .25em;margin: 0 auto;display: block;max-width: 150px;">Report
            Issue</a></p>
      </div>
      {% endif %}
    </div>
  </main>

  <footer>
    <div class="ad-box" id="footer-ad-1"></div>
    <hr>
    <ul class="footer-info">
      <li><a href="/rules">Policies & FAQs</a></li>•
      <li><a href="/report">Bug Report</a></li>•
      <li><a href="/data">Data Source</a></li>
    </ul>
    <hr>
    <ul class="footer-info">
      <li><a href="https://www.youtube.com/@MyBusTimes">YouTube</a></li>•
      <li><a href="https://www.tiktok.com/@mybustimes">TikTok</a></li>•
      <li><a href="https://discord.gg/mybustimes">Discord</a></li>•
      <li><a href="https://www.tiktok.com/@mybustimes">Facebook</a></li>
    </ul>
    <br><br>
    <a href="/account/subscribe" class="subscribe-link">
      <div>
        <h3>! Go Ad Free !</h3>
        <small>Go ad free and help support MBT</small>
      </div>
    </a>
    <br><br>
    <label for="theme-selector">Select Theme:</label>
    <select id="theme-selector" name="theme">
      {% for t in all_themes %}
      <option value="{{ t.pk }}" {% if request.user.is_authenticated %}
        {% if t.pk == request.user.theme_id %}selected{% endif %} {% else %}
        {% if t.pk|stringformat:"s" == request.COOKIES.themeID %}selected{% endif %} {% endif %}>{{ t.theme_name }}
      </option>
      {% endfor %}
    </select>

    <script>
      document.getElementById('menu-toggle').addEventListener('click', function () {
        const navMenu = document.getElementById('nav-menu');
        if (navMenu.style.display === 'none' || navMenu.style.display === '') {
          navMenu.style.display = 'block';
        } else {
          navMenu.style.display = 'none';
        }
      });
    </script>
    <script>
      document.getElementById('theme-selector').addEventListener('change', function () {
        const themeId = this.value;

        fetch("{% url 'set_theme' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              theme_id: themeId
            }),
          })
          .then(response => {
            if (!response.ok) throw new Error('Failed to set theme');
            return response.json();
          })
          .then(data => {
            // Refresh to load the new theme
            window.location.reload();
          })
          .catch(err => {
            alert(err.message);
          });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const adImages = JSON.parse('{{ live_ads|escapejs }}');
        const googleAds = JSON.parse('{{ google_ads|escapejs }}');

        const googleAdsEnabled = "{{ google_ads_enabled|yesno:'true,false' }}" === "true";
        const mbtAdsEnabled = "{{ mbt_ads_enabled|yesno:'true,false' }}" === "true";
        const adsEnabled = "{{ ads_enabled|yesno:'true,false' }}" === "true";

        if (adsEnabled) {
          function renderGoogleAd(adContainer) {
            const adId = adContainer.id;
            const type = adContainer.dataset.type || "default";
            adContainer.classList.add("ad-box-google");
            adContainer.style.position = "relative";
            adContainer.innerHTML = "";

            const loading = document.createElement("div");
            loading.className = "ad-loading-overlay";
            loading.textContent = "Loading...";
            adContainer.appendChild(loading);

            const ins = document.createElement("ins");
            ins.className = "adsbygoogle";
            ins.style.display = "block";
            if (type === "article") {
              ins.style.textAlign = "center";
              ins.setAttribute("data-ad-layout", "in-article");
            }
            ins.setAttribute("data-ad-format", "fluid");
            ins.setAttribute("data-ad-layout-key", "-gh+4m+2n-c9+cd");
            ins.setAttribute("data-ad-client", "ca-pub-8764676296426896");
            ins.setAttribute("data-ad-slot", googleAds[adId] || "");

            adContainer.appendChild(ins);

            if (adContainer.offsetWidth >= 250) {
              (adsbygoogle = window.adsbygoogle || []).push({});
            }

            setTimeout(() => {
              loading.remove();
              adContainer.style.border = "0";
            }, 500);
          }

          function renderImageAd(adContainer) {
            if (!adImages || adImages.length === 0) {
              adContainer.innerHTML = `<p style="text-align:center;">No ads available.</p>`;
              return;
            }
            const randomAd = adImages[Math.floor(Math.random() * adImages.length)];

            console.log("Rendering image ad:", randomAd);

            if (randomAd.ad_img_overide) {
              adContainer.innerHTML = `
              <a href="${randomAd.ad_link}" target="_blank" rel="noopener noreferrer">
                <img src="${randomAd.ad_img_overide}" alt="${randomAd.ad_name}" style="width:100%; height:auto;">
              </a>
            `;
              return;
            } else {             
              adContainer.innerHTML = `
                <a href="${randomAd.ad_link}" target="_blank" rel="noopener noreferrer">
                  <img src="/media/${randomAd.ad_img}" alt="${randomAd.ad_name}" style="width:100%; height:auto;">
                </a>
              `;
            }
          }

          function renderAllAds() {
            console.log("Rendering ads...");
            document.querySelectorAll(".ad-box").forEach((adContainer) => {
              const currentHour = new Date().getHours();
              let showGoogleAd = false;

              console.log(googleAdsEnabled);
              console.log(mbtAdsEnabled);

              if (googleAdsEnabled && mbtAdsEnabled) {
                showGoogleAd = currentHour >= 13 && currentHour < 21 ? Math.random() < 0.9 : Math.random() <
                  0.5;
              } else if (googleAdsEnabled) {
                showGoogleAd = true;
              } else if (mbtAdsEnabled) {
                showGoogleAd = false;
              }

              if (showGoogleAd && googleAds[adContainer.id]) {
                renderGoogleAd(adContainer);
              } else {
                renderImageAd(adContainer);
              }

              adContainer.style.display = "block";
            });
          }

          // not sure if this within TOS
          //fetchAds().then(() => {
          //  renderAllAds();
          //  setInterval(renderAllAds, 30000); // Refresh ads every 30 seconds
          //});
        }
      });
    </script>
    <br>
    <ul class="footer-info">
      <li id="users-stats">Online: {{ online_users_count }} | Total: {{ total_users_count }}</li>
    </ul>
    <br>
    <ul class="footer-info">
      <li><a href="https://status.mybustimes.cc">Site Status</a></li>•
      <li><a href="/status">Feature Status</a></li>•
      <li><a href="/site-updates">Service Updates</a></li>
    </ul>
    </div>
    <p>&copy; {% now "Y" %} MyBusTimes. All rights reserved.</p>
    {% if google_ads_enabled == True %}
    <div class="ad-box-no-auto">
      <ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed"
        data-ad-client="ca-pub-8764676296426896" data-ad-slot="2329788431"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
    {% endif %}
  </footer>
</body>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
  data-id="mybustimes" data-description="Support me on Buy me a coffee!" data-message=""
  data-color='#{{ brand_colour }}' data-position="Right" data-x_margin="18" data-y_margin="18">
</script>
<script>
  const timeout = new Promise(
    (_, reject) =>
    setTimeout(() => reject(new Error("Request timed out")), 2000) // 1-second timeout
  );

  let fetchData = fetch("/api/service-updates/?live=true");

  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return null;
  };

  const setCookie = (name, value, days) => {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/`;
  };

  Promise.race([fetchData, timeout])
    .then((response) => response.json())
    .then((data) => data.results)
    .then((data) => {
      const latestUpdate = data[0];
      const banner = document.getElementById("service-updates-banner");
      const buttom = document.getElementById("dismiss-btn");
      const bannerText = document.getElementById("banner-text");
      const main = document.querySelector("main");

      const dismissed = getCookie("banner-dismissed");
      const latestUpdateID = getCookie("latest-update-id");

      // Check if the banner has been dismissed and the latest update is not the same as the last one shown
      if (
        dismissed === "true" &&
        String(data[0].id) !== String(latestUpdateID)
      ) {
        banner.style.display = "none";
        main.style.margin = "55px auto";
      }

      if (Array.isArray(data) && data.length > 0) {
        let additionalUpdates = 0;

        // Check how many updates are between the latest update and the stored latest update ID
        if (latestUpdateID) {
          const filteredData = data.filter((item) => item.id >= latestUpdateID);
          additionalUpdates = filteredData.length - 2;
        }

        // If the update is different from the last one, display the banner
        if (String(latestUpdate.id) !== String(latestUpdateID)) {
          if (additionalUpdates > 0) {
            bannerText.textContent = `Update: ${latestUpdate.title} + ${additionalUpdates} more`;
          } else {
            bannerText.textContent = `Update: ${latestUpdate.title}`;
          }
          banner.style.display = "block";
          buttom.style.display = "block";
          main.style.margin = "6em auto";
        }
      } else {
        banner.textContent = "";
        banner.style.display = "none";
        buttom.style.display = "none";
        main.style.margin = "55px auto";
      }

      // Dismiss button functionality
      const dismissBtn = document.getElementById("dismiss-btn");
      dismissBtn.addEventListener("click", () => {
        setCookie("banner-dismissed", "true", 7); // expire in 7 days
        setCookie("latest-update-id", latestUpdate.id, 7); // expires in 7 days
        banner.style.display = "none";
        buttom.style.display = "none";
        main.style.margin = "55px auto";
      });

      banner.addEventListener("click", () => {
        setCookie("banner-dismissed", "true", 7); // expire in 7 days
        setCookie("latest-update-id", latestUpdate.id, 7); // expires in 7 days
        banner.style.display = "none";
        buttom.style.display = "none";
        main.style.margin = "55px auto";

        window.location.href = "/site-updates";
      });
    })
    .catch((error) => {
      console.error("Error fetching service updates:", error);
      const banner = document.getElementById("service-updates-banner");
      const main = document.querySelector("main");
      const buttom = document.getElementById("dismiss-btn");

      banner.textContent = "";
      banner.style.display = "none";
      buttom.style.display = "none";
      main.style.margin = "55px auto";
    });
</script>

</html>