{% extends 'base.html' %}
{% load static %}
{% load markdown_extras %}
{% load custom_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">

<style>
    #id_content_helptext {
        font-size: 0.9em;
        color: var(--text-color);
        margin-bottom: 1em;
        display: block;
        margin-top: -5px;
        opacity: 0.5;
    }

    .pfp-img {
        height: 40px;
        width: 40px;
        object-fit: cover;
        border-radius: 50%;
    }

    .user-info-post {
      display: flex;               /* horizontal layout */
      align-items: center;         /* vertically center items */
      gap: 10px;                   /* space between pfp and text */
    }

    .user-text {
      display: flex;
      flex-direction: column;      /* stack username and date vertically */
      justify-content: center;
      margin-left: -5px;
    }

    .user-text a, .user-text p {
      margin: 0;
      font-weight: 700;
      color: var(--text-color);                   /* remove default margins */
    }

    .user-text small {
      margin: 0;
      opacity: 0.6;
      font-size: 0.85em;
    }

    .post-content {
      margin-top: -10px;
      font-size: 1em;
      line-height: 1.5;
      margin-left: 10px;
      display: block;
    }

    .badges ul {
      display: inline-flex;
      margin: 0;
      text-wrap: nowrap;
      overflow-x: scroll;
      width: 100%;
      -ms-overflow-style: none;
      scrollbar-width: none;
      min-height: 34px;
    }

    .badges {
      margin-top: 0%;
    }

    .online-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #30b73e;
      border: 2px solid var(--background-color);
      margin-left: -20px;
      margin-top: -30px;
    }
</style>
{% endblock %}

{% block title %}
{{ thread.title }} - Forum
{% endblock %}

{% block content %}
<h2>{{ thread.title }}</h2>
<p><a href="{% url 'thread_list' %}">Back to threads</a></p>

{% for post in posts %}
{% if forloop.counter|divisibleby:10 %}
      <div  class="ad-box">
  <ins class="adsbygoogle"
      style="display:block"
      data-ad-format="fluid"
      data-ad-layout-key="-he+1j+4x-46-1s"
      data-ad-client="ca-pub-8764676296426896"
      data-ad-slot="7070995135"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script> 
</div>
{% endif %}
<div style="margin-bottom: 1.5em;" id="post-{{ post.post.id }}">
    <span class="user-info-post">
      <a href="{% if post.user_obj.username %}/u/{{ post.user_obj.username }}{% else %}#{% endif %}">
      <img src="{{ post.pfp|default_if_none:'' }}" onerror="this.src='/media/images/default_profile_pic.png'" alt="UserPFP" class="pfp-img">
      </a>
      {% if post.online %}
      <div class="online-indicator"></div>
      {% endif %}

      <div class="user-text">
        <a href="{% if post.user_obj.username %}/u/{{ post.user_obj.username }}{% else %}#{% endif %}"><p>{{ post.author }}</p></a>
        <small>{{ post.post.created_at|smart_datetime }}</small>
      </div>
    </span> 
    {{ userData.badges|json_script:"user_badges" }}
        <div class="badges" style="margin-bottom: 20px;">
            {% if post.user_obj.badges.all|length > 0 %}
            <ul>
                {% for badge in post.user_obj.badges.all %}
                <li class="badge"
                    style="background: {{ badge.badge_backgroud }}; color: {{ badge.badge_text_color }}; {{ badge.additional_css }}">
                    {{ badge.badge_name }}</li>
                {% endfor %}
            </ul>
            {% else %}
            {% endif %}
        </div>
    <span class="post-content">
      {{ post.post.content|urlize|linebreaksbr|markdownify|safe }}
    {% if post.post.image %}
    <img src="{{ post.post.image.url }}" style="max-width: 100%; max-height: 500px; height: auto;">
    {% endif %}
    </span>
    <hr>
</div>
{% endfor %}

<div class="pagination">
  <div class="pageination-center" style="margin: 0 auto;">
  {% if page_obj.has_previous %}
    <a href="?page=1" class="btn">« First</a>
    <a href="?page={{ page_obj.previous_page_number }}" class="btn">‹ Prev</a>
  {% else %}
    <span class="btn disabled">« First</span>
    <span class="btn disabled">‹ Prev</span>
  {% endif %}

  {# Show a few page numbers around current page #}
  {% for num in page_obj.paginator.page_range %}
    {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
      {% if num == page_obj.number %}
        <span class="btn current">{{ num }}</span>
      {% else %}
        <a href="?page={{ num }}" class="btn">{{ num }}</a>
      {% endif %}
    {% elif num == 1 or num == page_obj.paginator.num_pages %}
      <a href="?page={{ num }}" class="btn">{{ num }}</a>
    {% elif num == page_obj.number|add:-3 or num == page_obj.number|add:3 %}
      <span class="dots">…</span>
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}" class="btn">Next ›</a>
    <a href="?page={{ page_obj.paginator.num_pages }}" class="btn">Last »</a>
  {% else %}
    <span class="btn disabled">Next ›</span>
    <span class="btn disabled">Last »</span>
  {% endif %}
  </div>
</div>

{% if user.is_authenticated %}
  {% if not thread.locked %}
    {% if not thread.admin_only or user.is_staff %}
      <h3>Reply</h3>
      <form method="post" enctype="multipart/form-data" class="fleet-edit-wrapper">
          {% csrf_token %}
          {{ form.as_p }}
          <br>
          <button class="btn" type="submit">Post Reply</button>
      </form>
    {% else %}
      <p>This thread is for admins only.</p>
    {% endif %}
  {% else %}
    <p>This thread is locked.</p>
  {% endif %}
{% else %}
  <p><a href="{% url 'login' %}">Log in</a> to reply.</p>
{% endif %}

<script>
  const img = document.getElementById('logo');
if (img) {
  const h2 = document.createElement('h2');
  h2.textContent = "MBT Forums";
  h2.style.maxWidth = "125px";
  h2.style.display = "inline-block";
  h2.style.marginTop = "15px";
  img.parentNode.replaceChild(h2, img);
}

</script>
{% endblock %}