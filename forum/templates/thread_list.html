{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style> 
a {
  color: var(--text-color);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s ease;
}

a.button, 
a.button-new-thread {
  display: inline-block;
  background-color: var(--brand-color);
  color: white;
  padding: 0.4rem 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

a.button-new-thread:hover,
a.button-new-thread:focus {
  background-color: var(--brand-color-darker);
  text-decoration: none ;
}

ul.thread-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

ul.thread-list li {
  background: var(--background-color);
  margin-bottom: 0.75rem;
  padding: 0.75rem 1rem;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
  transition: background-color 0.2s ease;
}

ul.thread-list li:hover {
  background-color: var(--brand-color);
}

.thread-title {
  font-size: 1.1rem;
  font-weight: 700;
}

.thread-meta {
  font-size: 0.85rem;
  color: var(--text-color);
  margin-top: 0.25rem;
  opacity: 0.8;
}

.breadcrumb {
  display: none;
}

</style>

{% endblock %}

{% block title %}{{ forum_name }}{% endblock %}

{% block content %}
<h2>{{ forum_name }}</h2>
<a href="{% url 'forum_list' %}" style="color: var(--link-color);font-weight: initial;transition: none;margin-top: -1em;display: block;">Back to forums</a><br>

<a href="{% url 'new_thread' %}" class="button-new-thread">+ New Thread</a>

<!-- Filter and Search -->
<div style="margin-bottom: 1rem;">
  <select id="forum-filter">
    <option value="all">All Forums</option>
    {% for forum in forum_threads %}
      <option value="forum-{{ forum.forum.id }}">{{ forum.forum.name }}</option>
    {% endfor %}
  </select>

  <input type="text" id="thread-search" placeholder="Search threads..." style="margin-left: 1rem; padding: 0.4rem 0.6rem;">
</div>

{% if pinned_threads %}
<h2>Pinned Threads</h2>
<ul class="thread-list" id="pinned-threads">
  {% for thread in pinned_threads %}
  <li class="thread-item" data-forum-id="{{ thread.forum.id }}">
    <a href="{% url 'thread_detail' thread.id %}" class="thread-title">{{ thread.title }}</a>
    <div class="thread-meta">
      by {{ thread.created_by.username }} &bull; {{ thread.created_at|date:"M d, Y H:i" }}
    </div>
  </li>
  {% endfor %}
</ul>
<hr>
{% endif %}

{% for group in forum_threads %}
  <div id="forum-{{ group.forum.name|slugify }}">
    <h3>{{ group.forum.name }}</h3>
    <ul class="thread-list">
      {% for thread in group.threads %}
        <li class="thread-item" data-forum-id="{{ group.forum.id }}" onclick="location.href='{% url 'thread_detail' thread.id %}'">
          <a href="{% url 'thread_detail' thread.id %}" class="thread-title">{{ thread.title }}</a>
          <div class="thread-meta">
            by {{ thread.created_by.username }} &bull; {{ thread.created_at|date:"M d, Y H:i" }}
          </div>
        </li>

        {% if forloop.counter|divisibleby:5 %}
          <div class="ad-box ad-box-narrow" id="body-ad-1"></div>
        {% endif %}
      {% empty %}
        <li>No threads found in this forum.</li>
      {% endfor %}
    </ul>
  </div>
{% empty %}
  <li>No forums or threads found.</li>
{% endfor %}

<script>
  // Replace logo with MBT Forums
  const img = document.getElementById('logo');
  if (img) {
    const h2 = document.createElement('h2');
    h2.textContent = "MBT Forums";
    h2.style.maxWidth = "125px";
    h2.style.display = "inline-block";
    h2.style.marginTop = "15px";
    img.parentNode.replaceChild(h2, img);
  }

  // Live search and filter
  const searchInput = document.getElementById('thread-search');
  const filterSelect = document.getElementById('forum-filter');
  const threads = document.querySelectorAll('.thread-item');

  function filterThreads() {
    const searchText = searchInput.value.toLowerCase();
    const forumValue = filterSelect.value;

    // Map to track which parent divs should be visible
    const forumDivs = new Map();

    threads.forEach(thread => {
      const title = thread.querySelector('.thread-title').textContent.toLowerCase();
      const forumId = thread.dataset.forumId;

      const matchesSearch = title.includes(searchText);
      const matchesForum = forumValue === 'all' || forumValue === `forum-${forumId}`;

      if (matchesSearch && matchesForum) {
        thread.style.display = 'block';
        forumDivs.set(thread.closest('div'), true); // mark the parent div as visible
      } else {
        thread.style.display = 'none';
        if (!forumDivs.has(thread.closest('div'))) {
          forumDivs.set(thread.closest('div'), false);
        }
      }
    });

    // Hide entire forum div if it has no visible threads
    forumDivs.forEach((visible, div) => {
      const hasVisibleThreads = Array.from(div.querySelectorAll('.thread-item'))
        .some(t => t.style.display !== 'none');
      div.style.display = hasVisibleThreads ? 'block' : 'none';
    });
  }

  searchInput.addEventListener('input', filterThreads);
  filterSelect.addEventListener('change', filterThreads);
</script>
{% endblock %}