<form method="GET" action="/history" class="filter-form">
    <div class="form-fields">
      <div class="form-group">
        <label for="vehicle">Vehicle ID:</label>
        <input
          type="text" id="vehicle" name="vehicle"
          value="<%= vehicleID %>"
        >
      </div>
  
      <div class="form-group">
        <label for="user">Username:</label>
        <input
          type="text" id="user" name="user"
          value="<%= username %>"
        >
      </div>
  
      <div class="form-group">
        <label for="operator">Operator ID:</label>
        <input
          type="text" id="operator" name="operator"
          value="<%= operatorID %>"
        >
      </div>
  
      <div class="form-group">
        <label for="status">Status:</label>
        <select id="status" name="status">
          <option value="">All</option>
          <option value="approved"   <%= typeof approved   === 'true' ? 'selected' : '' %>>Approved</option>
          <option value="pending"    <%= typeof pending    === 'true' ? 'selected' : '' %>>Pending</option>
          <option value="disapproved"<%= typeof disapproved==='true' ? 'selected' : '' %>>Disapproved</option>
        </select>
      </div>
    </div>
  
    <button type="submit" class="filter-btn">Filter</button>
</form>
  
<p><%= error %></p>  

<% if (vehicleHistory) { %>
    <div class="history-container">
        <% vehicleHistory.forEach(change => { %>
            <div class="history-item">
                
                <p><a href="/operator/<%= change.operator %>/vehicle/<%= change.vehicle_id %>"><%= change.vehicle %></a> • <%
                    const timeDiff = new Date() - new Date(change.approved_at);
                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                    
                    if (days > 0) { %><%= days %> <%= days === 1 ? 'day' : 'days' %><% if (hours > 0) { %>, <%= hours %> <%= hours === 1 ? 'hour' : 'hours' %><% } if (minutes > 0) { %>, <%= minutes %> <%= minutes === 1 ? 'minute' : 'minutes' %><% } %><%
                    } else if (hours > 0) { %><%= hours %> <%= hours === 1 ? 'hour' : 'hours' %><% if (minutes > 0) { %>, <%= minutes %> <%= minutes === 1 ? 'minute' : 'minutes' %><% } %><%
                    } else if (minutes > 0) { %><%= minutes %> <%= minutes === 1 ? 'minute' : 'minutes' %><% if (minutes < 5 && seconds > 0) { %>, <%= seconds %> <%= seconds === 1 ? 'second' : 'seconds' %><% } %><%
                    } else { %><%= seconds %> <%= seconds === 1 ? 'second' : 'seconds' %><% }
                %> ago • <a href="/u/<%= change.user %>"><%= change.user %></a></p>
                
                <div class="history-changes">
                    <% change.changes.forEach(item => { %>
                        <div class="change-item">
                            <% if (item.field === 'livery_name') { %>
                                <span class="change-field"><strong><%= item.field.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ') %></strong></span>
                                <% if (item.from && item.from !== "No Livery") { %>
                                    <span class="change-from">from
                                        <div class="livery-cell" style="background: <%= change.changes.find(c => c.field === 'livery_css')?.from %>"></div>
                                        <%= item.from %>
                                    </span>
                                <% } %>
                                <% if (item.to && item.to !== "No Livery") { %>
                                    <span class="change-to">to
                                        <div class="livery-cell" style="background: <%= change.changes.find(c => c.field === 'livery_css')?.to %>"></div>
                                        <%= item.to %>
                                    </span>
                                <% } %>
                            <% } else if (item.field === 'colour') { %>
                                <span class="change-field"><strong><%= item.field.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ') %></strong></span>
                                <% if (item.from) { %>
                                    <span class="change-from">from
                                        <div class="livery-cell" style="background: <%= item.from %>"></div>
                                    </span>
                                <% } %>
                                <% if (item.to) { %>
                                    <span class="change-to">to
                                        <div class="livery-cell" style="background: <%= item.to %>"></div>
                                    </span>
                                <% } %>
                            <% } else if (item.field === 'features') { %>
                                <span class="change-field"><strong>Features</strong></span>
                                <% if (item.from && JSON.parse(item.from).length > 0) { %>
                                    <span class="change-from">from <%= JSON.parse(item.from).join(', ') %></span>
                                <% } %>
                                <% if (item.to && JSON.parse(item.to).length > 0) { %>
                                    <span class="change-to">to <%= JSON.parse(item.to).join(', ') %></span>
                                <% } %>
                            <% } else if (item.field !== 'livery_css') { %>
                                <span class="change-field"><strong><%= item.field.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ') %></strong></span>
                                <% if (item.from) { %>
                                    <span class="change-from">from <%= item.from %><%= item.field === 'length' ? 'm' : '' %></span>
                                <% } %>
                                <% if (item.to) { %>
                                    <span class="change-to">to <%= item.to %><%= item.field === 'length' ? 'm' : '' %></span>
                                <% } %>
                            <% } %>
                            <p><%= item.field %></p>
                        </div>
                    <% }) %>
                </div>
            </div>
        <% }) %>
    </div>
<% } else { %>
    <p>No history available for this vehicle.</p>
<% } %>
