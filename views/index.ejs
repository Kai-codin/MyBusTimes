<script>
  document.addEventListener('DOMContentLoaded', () => {
    let username = document.cookie.split('; ').find(row => row.startsWith('username='))?.split('=')[1];

    if (username) {
      document.getElementById("profile").textContent = 'My Profile';
      document.getElementById("profile").href = '/u/' + username;
    } else {
      document.getElementById("profile").textContent = 'Login';
      document.getElementById("profile").href = '/login';
    }
  });
</script>

<link rel="stylesheet" href="/css/narrow.css">

<h2>Message Of The Day</h2>
<p>
  <%= message %>
</p>

<h2>Search</h2>
<p>Search for operators or routes</p>
<div class="homeSearch">
  <form action="search">
    <input type="search" name="q" id="q" placeholder="Search">
    <input type="submit" value="Search">
  </form>
</div>
<div class="ad-box"></div>
<div class="helpful-links">
  <h2>Quick Links</h2>
  <ul class="chips">
    <li class="chip"><a id="profile" href="/">My Profile</a></li>
    <li class="chip"><a href="/">Create A Company</a></li>
    <li class="chip"><a href="/">Add Livery</a></li>
    <li class="chip"><a href="/">Ticketer (Alpha Demo)</a></li>
  </ul>  
</div>
<div id="regions-container"></div>
<div class="companys">
  <div>
    <ul>
      <li></li>
    </ul>
  </div>
  <div>
    <ul>
      <li></li>
    </ul>
  </div>
</div>

<script>
  fetch('http://localhost:8000/api/regions/')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('regions-container');
      const countries = {};

      // Group regions by country
      data.forEach(region => {
        const country = region.region_country;
        if (!countries[country]) {
          countries[country] = [];
        }
        countries[country].push(region);
      });

      // Sort countries alphabetically
      const sortedCountries = Object.keys(countries).sort();

      // Sort regions within each country alphabetically
      sortedCountries.forEach(country => {
        countries[country].sort((a, b) => a.region_name.localeCompare(b.region_name));

        const countrySection = document.createElement('div');
        const heading = document.createElement('h2');
        heading.textContent = country;
        countrySection.appendChild(heading);

        const list = document.createElement('ul');
        countries[country].forEach(region => {
          const listItem = document.createElement('li');
          const link = document.createElement('a');
          link.href = `/region/${region.region_code}`;
          link.textContent = region.region_name;
          listItem.appendChild(link);
          list.appendChild(listItem);
        });

        countrySection.appendChild(list);
        container.appendChild(countrySection);
      });
    })
    .catch(error => {
      console.error('Error fetching regions:', error);
    });
</script>