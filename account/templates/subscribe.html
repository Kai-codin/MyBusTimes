{% extends "mbtbase.html" %}

{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/narrow.css' %}">
  <style>
    .price_group h4 {
        margin-top: -30px;
        display: block ruby;
        margin-bottom: -7px;
    }
    .price_group h4 small {
        font-size: 0.6em;
        opacity: 0.7;
    }
    .cancel-anytime {
        margin-top: 0;
        margin-bottom: 0;
    }
    .best-value {
        background: #2ecc71;
        color: white;
        font-size: 0.75rem;
        padding: 3px 6px;
        border-radius: 6px;
        margin-bottom: 5px;
        display: inline-block;
    }

  </style>
{% endblock %}

{% block title %}Subscribe{% endblock %}

{% block content %}

{% if ads_enabled %}
<h2 class="section-title">Go Ad-Free</h2>
<p class="subtitle">Enjoy MyBusTimes distraction-free. Faster, cleaner, and built for the community - with your support</p>

<div class="adfree-benefits">
    <ul>
        <li>âœ… No ads</li>
        <li>âš¡ Faster page loads</li>
        <li>ðŸ›  Support MBT development</li>
        <li>ðŸ”’ No tracking or ad cookies</li>
    </ul>
</div>

{% if error_message %}
    <div class="error" style="color: red; margin-bottom: 1rem;">{{ error_message }}</div>
{% endif %}

<div class="subscription-options">
    <h3>Choose your plan</h3>
    <div class="price_group_container">

        <!-- Monthly -->
        <form method="POST">
            {% csrf_token %}
            <div class="price_group">
                <h3>Â£1<small>/mon</small></h3>
                <p>This will get you 1 month of ad-free MBT.</p>
                <input type="hidden" name="plan" value="monthly">
                <button type="submit" class="btn">Go Ad-Free | Monthly</button><br>
                <small class="cancel-anytime"><a href="{{ STRIPE_BILLING_PORTAL_URL }}">Cancel anytime</a></small>
            </div>
        </form>

        <!-- Yearly -->
        <form method="POST">
            {% csrf_token %}
            <div class="price_group">
                <h3>Â£10<small>/yr</small></h3>
                <h4>83p<small>/mon</small></h4>
                <div class="badge best-value">Best Value</div><br>
                <p style="margin-bottom: 0;">This will get you 1 year of ad-free MBT.</p>
                <input type="hidden" name="plan" value="yearly">
                <button type="submit" class="btn">Go Ad-Free | Yearly</button><br>
                <small class="cancel-anytime">Save 17% vs monthly</small>
                <small class="cancel-anytime"><a href="{{ STRIPE_BILLING_PORTAL_URL }}">Cancel anytime</a></small>
            </div>
        </form>
    </div>
    <br>
    <p style="text-align: center;">Join {{ current_sub_count }} other members in supporting MyBusTimes!</p>
    <a style="text-align: center;width: 100%;display: block;" href="https://www.mybustimes.cc/climate">ðŸŒ± Our climate promise</a>
    {% if themeDark == "True" %}
        <img src="{% static 'src/icons/secure-white.png' %}" alt="Pay with PayPal" style="max-height: 100px; margin: 0 auto;display: block;width: 100%;object-fit: contain;">
    {% else %}
        <img src="{% static 'src/icons/secure-black.png' %}" alt="Pay with PayPal" style="max-height: 100px; margin: 0 auto;display: block;width: 100%;object-fit: contain;">
    {% endif %}
</div>
<br>
<br>
<div class="subscription-options">
    <h3>Other options</h3>
    <div class="price_group_container">
        <!-- Custom -->
        <form method="POST">
            {% csrf_token %}
            <div class="price_group">
                <h3>Custom</h3>
                <p>Choose your own duration for ad-free MBT.</p>
                <select name="custom_months" id="custom_months_1" onchange="updateTotal('1')">
                    {% for i in month_options %}
                        <option value="{{ i }}">{{ i }} month{{ i|pluralize }}</option>
                    {% endfor %}
                </select>
                <p>Total: <span id="total_price_1">Â£1.00</span></p>
                <input type="hidden" name="plan" value="custom">
                <button type="submit" class="btn small">Start Custom</button>
            </div>
        </form>

        <!-- Gift -->
        <form method="POST">
            {% csrf_token %}
            <div class="price_group">
                <h3>Gift</h3>
                <p>Gift someone ad-free MBT for up to a year.</p>
                <input type="text" name="gift_username" placeholder="Username"
                       value="{{ gift_username_value|default:'' }}"
                       {% if gift_username_error %}style="border: 2px solid red;"{% endif %} required>
                {% if gift_username_error %}
                    <p style="color: red;">{{ error_message }}</p>
                {% endif %}

                <select name="custom_months" id="custom_months_2" onchange="updateTotal('2')">
                    {% for i in month_options %}
                        <option value="{{ i }}">{{ i }} month{{ i|pluralize }}</option>
                    {% endfor %}
                </select>
                <p>Total: <span id="total_price_2">Â£1.00</span></p>
                <input type="hidden" name="plan" value="gift">
                <button type="submit" class="btn small">Send Gift</button>
            </div>
        </form>

    </div>
</div>

<div class="note">
    <p>Youâ€™re directly helping keep MyBusTimes fast and focused on buses â€“ not ads.</p>
</div>
{% else %}
<h2>Looks like you're already subscribed! Thank you.</h2>
<a href="{{ STRIPE_BILLING_PORTAL_URL }}">Cancel anytime</a>
{% endif %}
<script>
    function updateTotal(groupId) {
        const dropdown = document.getElementById('custom_months_' + groupId);
        const pricePerMonth = 1;
        const total = pricePerMonth * parseInt(dropdown.value);
        document.getElementById('total_price_' + groupId).innerText = `Â£${total.toFixed(2)}`;
    }

    // Initialize totals on load
    document.addEventListener("DOMContentLoaded", function () {
        updateTotal('1');
        updateTotal('2');
    });
</script>
{% endblock %}
