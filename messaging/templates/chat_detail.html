{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
  #chat-messages {
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .message {
    margin-bottom: 0.75rem;
  }
  .message .sender {
    font-weight: bold;
  }
  .message .timestamp {
    font-size: 0.8rem;
    opacity: 0.6;
  }

  .message.You {
    max-width: 75%;
    margin-left: auto;    /* Push it fully right */
    margin-right: 0;      /* Optional: explicitly no right margin */
    text-align: right;
    background: var(--brand-color);
    color: white;
    border-radius: 0.5em 0 0.5em 0.5em;
    padding: 0.5em 1em;
    width: fit-content;
    word-wrap: break-word;
  }

  .message.Other {
    max-width: 75%;
    margin-right: 25%;
    text-align: left;
    border-radius: 0 0.5em 0.5em 0.5em; /* opposite rounded corners */
    padding: 0.5em 1em;
    width: fit-content;
    word-wrap: break-word;
    background: #88888810;
  }
</style>
{% endblock %}

{% block title %}
  {% if chat.chat_type == "direct" %}
    Direct Chat #{{ chat.id }}
  {% else %}
    {{ chat.name|default:"(Unnamed Group)" }}
  {% endif %}
{% endblock %}

{% block content %}
<h1>
  {% if chat.chat_type == "direct" %}
    Direct Chat #{{ chat.id }}
  {% else %}
    {{ chat.name|default:"(Unnamed Group)" }}
  {% endif %}
</h1>

<div id="chat-messages" role="log" aria-live="polite" aria-relevant="additions">
  {% for message in messages %}
    {% if message.sender == request.user %}
      <div class="message You" data-message-id="{{ message.id }}">
        <span class="sender">You</span><br>
        <span class="text">{{ message.text|linebreaksbr }}</span><br>
        <small class="timestamp">{{ message.created_at|date:"H:i" }}</small>
        <!-- show read status only for others -->
      </div>
    {% else %}
      <div class="message Other" data-message-id="{{ message.id }}">
        <span class="sender">{{ message.sender.username }}</span><br>
        <span class="text">{{ message.text|linebreaksbr }}</span><br>
        <small class="timestamp">{{ message.created_at|date:"H:i" }}</small>
      </div>
    {% endif %} 
  {% empty %}
    <p>No messages yet. Say hello!</p>
  {% endfor %}
</div>

<form id="chat-form">
  {% csrf_token %}
  <textarea id="message-input" autocomplete="off" placeholder="Type your message..." class="form-control" style="width: 100%;height: 150px;"></textarea><br>
  <button style="float: right;margin-top: 10px;" type="submit" class="btn btn-primary mt-2">Send</button>
</form>
<br>
<a href="{% url 'messaging_home' %}" class="btn btn-secondary mt-3">Back to Chats</a>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatId = "{{ chat.id }}";
  const userName = "{{ request.user.username|escapejs }}";
  const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const chatSocket = new WebSocket(
    wsProtocol + '://' + window.location.host + '/message/ws/chat/' + chatId + '/'
  );

  const chatMessages = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');

  chatForm.onsubmit = function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    console.log("[CLIENT] Sending message:", message);
    if (message) {
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInput.value = '';
    }
  };

  chatSocket.onmessage = function(e) {
    console.log("[CLIENT] Received:", e.data);
    const data = JSON.parse(e.data);
    if (data.message) {
      const date = new Date(data.timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const formattedTime = `${hours}:${minutes}`;
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add('You');
      messageDiv.innerHTML = `<span class="sender">You</span><br><span class="text"></span><br><small class="timestamp">${formattedTime}</small>`;
      messageDiv.querySelector('.text').innerHTML = data.message.replace(/\n/g, '<br>');
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };
});

</script>
{% endblock %}
