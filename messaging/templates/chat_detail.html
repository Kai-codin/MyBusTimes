{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
  #chat-messages {
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .message {
    margin-bottom: 0.75rem;
  }

  .message .sender {
    font-weight: bold;
  }

  .message .timestamp {
    font-size: 0.8rem;
    opacity: 0.6;
  }

  .message.You {
    max-width: 75%;
    margin-left: auto;
    text-align: right;
    background: var(--brand-color);
    color: white;
    border-radius: 0.5em 0 0.5em 0.5em;
    padding: 0.5em 1em;
    width: fit-content;
    word-wrap: break-word;
  }

  .message.Other {
    max-width: 75%;
    margin-right: 25%;
    text-align: left;
    border-radius: 0 0.5em 0.5em 0.5em;
    padding: 0.5em 1em;
    width: fit-content;
    word-wrap: break-word;
    background: #88888810;
  }

  #image-popup {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
  }

  #image-popup img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 0.5em;
  }

  #image-popup span {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 2rem;
    cursor: pointer;
  }

  .spinner {
    border: 2px solid #f3f3f3;
    /* Light gray */
    border-top: 2px solid #fff;
    /* White */
    border-radius: 50%;
    width: 14px;
    height: 14px;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
    margin-left: 5px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}

{% block title %}
{% if chat.chat_type == "direct" %}Direct Chat
#{{ chat.id }}{% else %}{{ chat.name|default:"(Unnamed Group)" }}{% endif %}
{% endblock %}

{% block content %}
<h1>{% if chat.chat_type == "direct" %}Direct Chat
  #{{ chat.id }}{% else %}{{ chat.name|default:"(Unnamed Group)" }}{% endif %}</h1>

<div id="chat-messages" role="log" aria-live="polite" aria-relevant="additions">
  {% for message in messages %}
  <div class="message {% if message.sender == request.user %}You{% else %}Other{% endif %}"
    data-message-id="{{ message.id }}">
    <span
      class="sender">{% if message.sender == request.user %}You{% else %}{{ message.sender.username }}{% endif %}</span><br>
    <span class="text">{{ message.text|linebreaksbr }}</span><br>
    {% if message.image %}
    <img src="{{ message.image.url }}" class="chat-image" style="max-width:200px; margin-top:5px; cursor:pointer;"><br>
    {% endif %}
    {% if message.file %}
    <a href="{{ message.file.url }}" target="_blank">Download file</a><br>
    {% endif %}
    <small class="timestamp">{{ message.created_at|date:"H:i" }}</small>
  </div>
  {% empty %}
  <p>No messages yet. Say hello!</p>
  {% endfor %}
</div>

<form id="chat-form" enctype="multipart/form-data">
  {% csrf_token %}
  <textarea id="message-input" autocomplete="off" placeholder="Type your message..." class="form-control"
    style="width:100%;height:150px;" required></textarea><br>
  <input type="file" id="file-input" name="file" style="margin-top:10px;"
    accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.txt"><br>
  <button style="float:right;margin-top:10px;" type="submit" class="btn btn-primary mt-2">Send</button>
</form>

<br>
<a href="{% url 'messaging_home' %}" class="btn btn-secondary mt-3">Back to Chats</a>

<div id="image-popup">
  <span id="close-popup">&times;</span>
  <img id="popup-img" src="" alt="Full Image">
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const chatId = "{{ chat.id }}";
    const userName = "{{ request.user.username|escapejs }}";
    const chatSocket = new WebSocket(
      (window.location.protocol === 'https:' ? 'wss' : 'ws') +
      '://' + window.location.host + '/message/ws/chat/' + chatId + '/'
    );

    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');

    const imagePopup = document.getElementById('image-popup');
    const popupImg = document.getElementById('popup-img');
    const closePopup = document.getElementById('close-popup');

    closePopup.onclick = () => imagePopup.style.display = 'none';
    imagePopup.onclick = e => {
      if (e.target === imagePopup) imagePopup.style.display = 'none';
    };

    function attachImageClickHandlers(container) {
      container.querySelectorAll('.chat-image').forEach(img => {
        img.onclick = () => {
          popupImg.src = img.src;
          imagePopup.style.display = 'flex';
        };
      });
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.onsubmit = function (e) {
      e.preventDefault();
      const message = messageInput.value.trim();
      const file = fileInput.files[0];
      const sendButton = chatForm.querySelector('button[type="submit"]');

      if (!message && !file) return;

      // Client-side size check
      if (file && file.size > 10 * 1024 * 1024) { // 10 MB
        alert("File too large! Maximum size is 10 MB.");
        fileInput.value = "";
        return;
      }

      // Disable button and show spinner
      sendButton.disabled = true;
      const spinner = document.createElement('span');
      spinner.classList.add('spinner');
      sendButton.appendChild(spinner);

      const formData = new FormData();
      formData.append("csrfmiddlewaretoken", document.querySelector('[name=csrfmiddlewaretoken]').value);
      formData.append("chat_id", chatId);
      if (message) formData.append("text", message);
      if (file) formData.append("file", file);

      fetch("{% url 'chat_send_file' %}", {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (!response.ok) throw new Error("Network error");
        })
        .catch(err => alert("Failed to send message: " + err))
        .finally(() => {
          // Re-enable button and remove spinner
          sendButton.disabled = false;
          spinner.remove();
          messageInput.value = '';
          fileInput.value = '';
        });
    };

    attachImageClickHandlers(document);
    scrollToBottom();

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (!data.message && !data.image_url && !data.file_url) return;

      const date = new Date(data.timestamp);
      const formattedTime =
        `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;

      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message', data.sender === userName ? 'You' : 'Other');

      let html = `<span class="sender">${data.sender === userName ? "You" : data.sender}</span><br>`;
      if (data.message) html += `<span class="text">${data.message.replace(/\n/g,'<br>')}</span><br>`;
      if (data.image_url) html +=
        `<img src="${data.image_url}" class="chat-image" style="max-width:200px;margin-top:5px;cursor:pointer;"><br>`;
      if (data.file_url) html += `<a href="${data.file_url}" target="_blank">Download file</a><br>`;
      html += `<small class="timestamp">${formattedTime}</small>`;

      msgDiv.innerHTML = html;
      chatMessages.appendChild(msgDiv);
      attachImageClickHandlers(msgDiv);
      scrollToBottom();
    };

    chatSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };
  });
</script>
{% endblock %}